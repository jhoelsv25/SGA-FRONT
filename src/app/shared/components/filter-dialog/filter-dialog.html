<!-- filter-dialog/filter-dialog.html -->
@if (isOpen()) {
  <div
    class="fixed inset-0 z-50 flex items-end sm:items-center justify-center sm:p-4 bg-black/50 backdrop-blur-sm animate-in fade-in duration-200"
    role="dialog"
    aria-modal="true"
    aria-labelledby="filter-dialog-title"
    tabindex="-1"
    (click)="onClose()"
    (keydown.escape)="onClose()"
  >
    <div
      class="bg-white dark:bg-base-200 rounded-t-2xl sm:rounded-xl shadow-2xl w-full sm:max-w-4xl max-h-[90vh] sm:max-h-[85vh] overflow-hidden animate-in slide-in-from-bottom sm:zoom-in-95 duration-200"
      role="document"
      tabindex="0"
      (click)="$event.stopPropagation()"
      (keydown)="$event.stopPropagation()"
    >
      <!-- Header -->
      <div
        class="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-base-300 dark:border-base-200 bg-base-50 dark:bg-base-300"
      >
        <div class="flex items-center gap-2 sm:gap-3 min-w-0">
          <div
            class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center shrink-0"
          >
            <i
              class="fas fa-sliders-h text-sm sm:text-base text-primary-600 dark:text-primary-400"
            ></i>
          </div>
          <div class="min-w-0">
            <h2
              id="filter-dialog-title"
              class="text-[15px] sm:text-lg font-bold text-gray-800 dark:text-white truncate"
            >
              Filtrar resultados
            </h2>
            <p class="text-xs text-neutral-500 dark:text-neutral-400 hidden sm:block">
              Aplica filtros para refinar tu búsqueda
            </p>
          </div>
        </div>
        <button
          type="button"
          class="w-8 h-8 rounded-lg hover:bg-base-200 dark:hover:bg-base-200 transition-colors duration-200 flex items-center justify-center shrink-0"
          (click)="onClose()"
        >
          <i class="fas fa-times text-neutral-600 dark:text-neutral-300"></i>
        </button>
      </div>

      <!-- Body -->
      <div
        class="px-4 sm:px-6 py-4 sm:py-6 overflow-y-auto max-h-[calc(90vh-140px)] sm:max-h-[calc(85vh-200px)]"
      >
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
          @for (field of fields(); track field.key) {
            <div class="flex flex-col gap-2">
              <label
                [for]="'filter-' + field.key"
                class="text-sm font-semibold text-neutral-700 dark:text-neutral-200"
              >
                {{ field.label }}
              </label>

              @switch (field.type) {
                @case ('text') {
                  <input
                    [id]="'filter-' + field.key"
                    type="text"
                    class="px-3 py-2 text-sm border border-base-300 rounded-lg bg-white dark:bg-base-300 dark:border-base-200 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-all duration-200 outline-none"
                    [placeholder]="field.placeholder || 'Ingrese texto...'"
                    [value]="currentFilters()[field.key] || ''"
                    (input)="onFilterChange(field.key, $any($event.target).value)"
                  />
                }

                @case ('number') {
                  <input
                    [id]="'filter-' + field.key"
                    type="number"
                    class="px-3 py-2 text-sm border border-base-300 rounded-lg bg-white dark:bg-base-300 dark:border-base-200 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-all duration-200 outline-none"
                    [placeholder]="field.placeholder || 'Ingrese número...'"
                    [value]="currentFilters()[field.key] ?? ''"
                    (input)="
                      onFilterChange(
                        field.key,
                        $any($event.target).value !== '' ? +$any($event.target).value : null
                      )
                    "
                  />
                }

                @case ('date') {
                  <sga-date-picker
                    [placeholder]="field.placeholder || 'Seleccionar fecha...'"
                    [value]="$any(currentFilters()[field.key]) || null"
                    (valueChange)="onFilterChange(field.key, $event)"
                    [clearable]="true"
                  />
                }

                @case ('date-range') {
                  <sga-date-picker
                    [rangeMode]="true"
                    [placeholder]="field.placeholder || 'Seleccionar rango...'"
                    [value]="$any(currentFilters()[field.key]) || { start: null, end: null }"
                    (valueChange)="onFilterChange(field.key, $event)"
                    [clearable]="true"
                  />
                }

                @case ('boolean') {
                  <select
                    [id]="'filter-' + field.key"
                    class="px-3 py-2 text-sm border border-base-300 rounded-lg bg-white dark:bg-base-300 dark:border-base-200 dark:text-white focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-all duration-200 outline-none"
                    [value]="currentFilters()[field.key] ?? ''"
                    (change)="
                      onFilterChange(
                        field.key,
                        $any($event.target).value === 'true'
                          ? true
                          : $any($event.target).value === 'false'
                            ? false
                            : null
                      )
                    "
                  >
                    <option value="">Todos</option>
                    <option value="true">Sí</option>
                    <option value="false">No</option>
                  </select>
                }

                @case ('select') {
                  <sga-select
                    [options]="field.options ?? []"
                    [config]="{ keyField: 'value', labelField: 'label' }"
                    [value]="currentFilters()[field.key] ?? (field.multiple ? [] : null)"
                    (valueChange)="onFilterChange(field.key, $event)"
                    [multiple]="field.multiple || false"
                    [placeholder]="field.placeholder || 'Seleccionar...'"
                    [clearable]="true"
                  />
                }
              }
            </div>
          }
        </div>
      </div>

      <!-- Footer -->
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 px-4 sm:px-6 py-3 sm:py-4 border-t border-base-300 dark:border-base-200 bg-base-50 dark:bg-base-300"
      >
        <button
          type="button"
          sgaButton
          color="danger"
          variant="ghost"
          size="sm"
          (click)="onClear()"
          [disabled]="activeCount === 0"
          class="w-full sm:w-auto justify-center sm:justify-start"
        >
          <i class="fas fa-times-circle mr-1.5"></i>
          <span>Limpiar filtros</span>
        </button>

        <div class="flex items-center gap-2">
          <button
            type="button"
            appButton
            color="secondary"
            variant="outline"
            size="sm"
            (click)="onClose()"
            class="flex-1 sm:flex-initial"
          >
            Cancelar
          </button>
          <button
            type="button"
            appButton
            color="primary"
            variant="solid"
            size="sm"
            (click)="onApply()"
            class="flex-1 sm:flex-initial"
          >
            <i class="fas fa-check mr-1.5"></i>
            Aplicar filtros
          </button>
        </div>
      </div>
    </div>
  </div>
}
