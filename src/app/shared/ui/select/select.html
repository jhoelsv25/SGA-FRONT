<!-- Custom Select Component con Tailwind CSS -->
<div class="relative w-full" [class]="isDisabled() ? 'pointer-events-none opacity-50' : ''">
  <!-- Select Trigger -->
  <div
    class="flex items-center justify-between w-full min-h-10 px-3 py-2 text-sm border rounded-lg cursor-pointer transition-all duration-200 outline-none"
    [class]="getTriggerClasses()"
    (click)="toggleDropdown()"
    (keydown)="onKeyDown($event)"
    tabindex="0"
    role="combobox"
    [attr.aria-expanded]="isOpen()"
    [attr.aria-haspopup]="true"
    [attr.aria-disabled]="isDisabled()"
    aria-controls="select-options-list"
  >
    <!-- Display Text -->
    <span
      class="flex-1 text-left truncate"
      [class]="
        hasSelection()
          ? 'text-neutral-800 dark:text-white'
          : 'text-neutral-400 dark:text-neutral-300'
      "
    >
      {{ displayText() }}
    </span>

    <div class="flex items-center gap-1">
      <!-- Clear Button -->
      @if (clearable() && hasSelection() && !isDisabled()) {
        <button
          type="button"
          class="flex items-center justify-center w-5 h-5 text-neutral-400 hover:text-neutral-600 hover:bg-base-200 rounded transition-colors duration-200 dark:text-neutral-300 dark:hover:text-white"
          (click)="clearSelection(); $event.stopPropagation()"
          tabindex="-1"
        >
          <i class="fas fa-times text-xs"></i>
        </button>
      }

      <!-- Loading Spinner -->
      @if (loading()) {
        <div class="flex items-center justify-center w-5 h-5 text-primary-500">
          <i class="fas fa-spinner fa-spin text-sm"></i>
        </div>
      } @else {
        <!-- Dropdown Arrow -->
        <div
          class="flex items-center justify-center w-5 h-5 text-neutral-400 transition-transform duration-200 dark:text-neutral-300"
          [class.rotate-180]="isOpen()"
        >
          <i class="fas fa-chevron-down text-xs"></i>
        </div>
      }
    </div>
  </div>

  <!-- Dropdown Content -->
  @if (isOpen()) {
    <div
      class="absolute top-full left-0 right-0 z-50 mt-1 bg-base border border-base-300 rounded-lg shadow-lg max-h-72 overflow-hidden animate-in slide-in-from-top-2 duration-200 dark:bg-base dark:border-base-200"
    >
      <!-- Search Input -->
      @if (searchable()) {
        <div class="p-3 border-b border-base-200">
          <div class="relative">
            <input
              #searchInput
              type="text"
              class="w-full pl-9 pr-3 py-2 text-sm border border-base-300 rounded-md bg-base text-neutral-800 placeholder-neutral-400 outline-none transition-colors duration-200 focus:border-primary-500 focus:ring-2 focus:ring-primary-300 dark:bg-base dark:border-base-200 dark:text-white dark:placeholder-neutral-300"
              [placeholder]="searchPlaceholder()"
              [value]="searchTerm()"
              (input)="onSearchInput($event)"
              (keydown)="onKeyDown($event)"
            />
            <i
              class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-neutral-400 text-sm pointer-events-none dark:text-neutral-300"
            ></i>
          </div>
        </div>
      }

      <!-- Options List -->
      <div class="max-h-48 overflow-y-auto py-1" role="listbox">
        @if (filteredOptions().length === 0) {
          <!-- No Options Message -->
          <div
            class="px-3 py-4 text-center text-neutral-500 text-sm italic dark:text-neutral-400 flex flex-col items-center gap-2"
          >
            @if (searchTerm()) {
              @if (loading()) {
                <span>Buscando...</span>
              } @else {
                <span>No se encontraron resultados para "{{ searchTerm() }}"</span>
                <!-- Botón Agregar -->
                @if (showAddButtonFn()) {
                  <button
                    type="button"
                    class="mt-2 px-4 py-1.5 text-sm font-semibold rounded-md bg-primary-500 text-white hover:bg-primary-600 transition-colors duration-200 shadow"
                    (click)="emitAddRequested(searchTerm())"
                  >
                    Agregar "{{ searchTerm() }}"
                  </button>
                }
              }
            } @else {
              <span>No hay opciones disponibles</span>
            }
          </div>
        } @else {
          <!-- Option Items -->
          @for (option of filteredOptions(); track getOptionValue()(option); let i = $index) {
            <div
              class="flex items-center px-3 py-2 text-sm cursor-pointer transition-colors duration-150"
              [class]="getOptionClasses(option, i)"
              (click)="selectOption(option)"
              (keydown.enter)="selectOption(option)"
              (keydown.space)="selectOption(option)"
              tabindex="0"
              role="option"
              [attr.aria-selected]="isSelected(option)"
            >
              <!-- Multiple Selection Checkbox -->
              @if (multiple()) {
                <div class="mr-2 flex items-center justify-center">
                  <span
                    class="inline-flex items-center justify-center w-5 h-5 border-2 border-primary-500 rounded text-primary-500 bg-white dark:bg-base-100"
                  >
                    <i
                      class="fas text-base"
                      [class]="
                        isSelected(option)
                          ? 'fa-check-square text-primary-500'
                          : 'fa-square text-neutral-300'
                      "
                    ></i>
                  </span>
                </div>
              }

              <!-- Option Content -->
              <div class="flex-1 flex flex-col">
                <span class="font-medium">{{ getOptionLabel()(option) }}</span>
                @if (option['subtitle']) {
                  <small class="text-neutral-500 text-xs mt-0.5 dark:text-neutral-400">{{
                    option['subtitle']
                  }}</small>
                }
              </div>

              <!-- Selected Check (for single selection) -->
              @if (!multiple() && isSelected(option)) {
                <div class="ml-2 text-primary-500">
                  <i class="fas fa-check text-base"></i>
                </div>
              }
            </div>
          }
        }
      </div>

      <!-- Multiple Selection Footer -->
      @if (multiple() && hasSelection()) {
        <div
          class="p-2 border-t border-base-200 bg-base-50 dark:bg-base-100 flex items-center justify-center"
        >
          <button
            type="button"
            class="w-full px-3 py-1.5 text-sm bg-transparent border border-base-300 rounded-md text-neutral-600 hover:bg-base-100 hover:border-base-400 transition-colors duration-200 dark:border-base-200 dark:text-neutral-300 dark:hover:bg-base-200"
            (click)="clearSelection()"
          >
            Limpiar selección
          </button>
        </div>
      }
    </div>
  }
</div>
