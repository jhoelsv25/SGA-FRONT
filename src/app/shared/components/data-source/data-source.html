<!-- data-source.html -->
<div
  class="w-full rounded-lg bg-base-200 shadow-sm border border-base-300 dark:border-base-200 p-4"
>
  <!-- Toolbar -->
  <header
    class="flex flex-col md:flex-row justify-between items-stretch md:items-center gap-3 w-full py-3"
  >
    <!-- Mass Actions -->
    <div class="flex items-center gap-2 flex-wrap">
      <!-- Delete Button -->
      <button
        type="button"
        appButton
        color="danger"
        variant="solid"
        size="sm"
        [disabled]="!hasSelection()"
        title="Eliminar seleccionados"
        (click)="onMassDelete()"
      >
        <i class="fas fa-trash"></i>
        @if (hasSelection()) {
          <span class="text-xs ml-1">({{ selectedRows().size }})</span>
        }
      </button>

      <!-- Separator -->
      @if (hasSelection() && filteredMassActions().length > 0) {
        <div class="w-px h-6 bg-base-300 dark:bg-base-200"></div>
      }

      <!-- Dynamic Mass Actions -->
      @if (hasSelection()) {
        @for (action of filteredMassActions(); track action.key) {
          @if (isVisible(action)) {
            <button
              type="button"
              sgaButton
              [color]="action.color || 'primary'"
              [variant]="action.variant || 'outline'"
              [size]="action.size || 'sm'"
              [disabled]="isDisabled(action)"
              [title]="action.label"
              (click)="executeMassAction(action)"
            >
              @if (action.icon) {
                <i [class]="action.icon"></i>
              }
              @if (action.showLabel) {
                <span class="ml-1">{{ action.label }}</span>
              }
            </button>
          }
        }
        <span class="text-sm text-neutral-600 dark:text-neutral-400 ml-2">
          {{ selectedRows().size }} seleccionado(s)
        </span>
      }
    </div>

    <!-- Search -->
    <div class="flex items-center gap-2 w-full md:w-auto md:min-w-[300px]">
      <sga-search (searchChange)="onLocalSearch($event)" />
    </div>
  </header>

  <!-- Table Container -->
  <div class="relative overflow-hidden rounded-lg">
    <!-- Loading -->
    @if (loading()) {
      <div
        class="absolute inset-0 z-20 bg-base/70 flex items-center justify-center backdrop-blur-sm"
      >
        <div class="flex flex-col items-center gap-3">
          <i class="fas fa-spinner fa-spin text-3xl text-primary-500"></i>
          <span class="text-lg font-semibold text-primary-700 dark:text-primary-300"
            >Cargando...</span
          >
        </div>
      </div>
    }

    <div class="overflow-auto" style="max-height: calc(100vh - 300px)">
      <table
        class="w-full rounded-lg overflow-hidden shadow border border-base-300 dark:border-base-200"
      >
        <!-- Header -->
        <thead class="bg-base-100 dark:bg-base-200 border-b-2 border-gray-300 sticky top-0 z-10">
          <tr>
            <!-- Select All -->
            @if (config().selectable && config().multiSelect) {
              <th class="w-12 px-4 py-3">
                <label class="inline-flex items-center cursor-pointer group">
                  <input
                    type="checkbox"
                    class="sr-only"
                    [checked]="allSelected()"
                    [indeterminate]="partialSelected()"
                    (change)="toggleAll()"
                  />
                  <div
                    class="w-5 h-5 border-2 rounded flex items-center justify-center transition-all"
                    [class.bg-primary-500]="allSelected() || partialSelected()"
                    [class.border-primary-500]="allSelected() || partialSelected()"
                    [class.border-neutral-400]="!allSelected() && !partialSelected()"
                  >
                    @if (allSelected()) {
                      <i class="fas fa-check text-white text-xs"></i>
                    } @else if (partialSelected()) {
                      <i class="fas fa-minus text-white text-xs"></i>
                    }
                  </div>
                </label>
              </th>
            } @else {
              <th class="w-10"></th>
            }

            <!-- Columns -->
            @for (col of columns(); track col.key) {
              @if (isColumnVisible(col)) {
                <th
                  class="px-4 py-3 text-left text-sm font-semibold text-neutral-700 dark:text-neutral-200 cursor-pointer"
                  [class]="getColumnClasses(col)"
                  [style.width]="col.width"
                  (click)="col.sortable ? sortColumn(col) : null"
                >
                  <div class="flex items-center gap-2">
                    <span>{{ col.label }}</span>
                    @if (col.sortable && config().sortable) {
                      <i [class]="getSortIcon(col)"></i>
                    }
                  </div>
                </th>
              }
            }

            <!-- Actions Header -->
            @if (hasActions()) {
              <th
                class="w-24 px-4 py-3 text-sm font-medium sticky right-0 bg-base-100 dark:bg-base-200 z-10"
              >
                Acciones
              </th>
            }
          </tr>
        </thead>

        <!-- Body -->
        <tbody>
          @if (displayData().length === 0) {
            <tr>
              <td
                [attr.colspan]="
                  columns().length + (config().selectable ? 1 : 0) + (hasActions() ? 1 : 0)
                "
                class="px-4 py-8 text-center text-neutral-500"
              >
                <div class="flex flex-col items-center gap-2">
                  <i class="fas fa-table text-2xl text-neutral-300"></i>
                  <span>No hay datos disponibles</span>
                </div>
              </td>
            </tr>
          } @else {
            @for (row of sortedData(); track $index; let i = $index) {
              <tr
                [class]="getRowClasses(row)"
                class="border-b border-neutral-200 dark:border-base-200 transition-colors"
                [attr.draggable]="config().rowDraggable"
              >
                <!-- Selection -->
                @if (config().selectable) {
                  <td class="px-4 py-3">
                    <label class="inline-flex items-center cursor-pointer group">
                      <input
                        [type]="config().multiSelect ? 'checkbox' : 'radio'"
                        class="sr-only"
                        [checked]="isSelected(row)"
                        (change)="toggleRow(row)"
                        (click)="$event.stopPropagation()"
                      />
                      <div
                        class="w-5 h-5 border-2 flex items-center justify-center transition-all"
                        [class.rounded]="config().multiSelect"
                        [class.rounded-full]="!config().multiSelect"
                        [class.bg-primary-500]="isSelected(row)"
                        [class.border-primary-500]="isSelected(row)"
                        [class.border-neutral-400]="!isSelected(row)"
                      >
                        @if (isSelected(row)) {
                          @if (config().multiSelect) {
                            <i class="fas fa-check text-white text-xs"></i>
                          } @else {
                            <div class="w-2.5 h-2.5 bg-primary-500 rounded-full"></div>
                          }
                        }
                      </div>
                    </label>
                  </td>
                }

                <!-- Cells -->
                @for (col of columns(); track col.key) {
                  @if (isColumnVisible(col, row)) {
                    <td
                      class="px-4 py-3 text-sm text-neutral-800 dark:text-white"
                      [class]="getCellClasses(col, row)"
                      [style.width]="col.width"
                      [style.min-width]="col.minWidth"
                      [style.max-width]="col.maxWidth"
                      [class.truncate]="col.truncate"
                      [title]="col.showTooltip ? formatCell(row, col) : ''"
                      (click)="col.onClick?.(getRowProperty(row, col.key), row)"
                      (dblclick)="col.onDblClick?.(getRowProperty(row, col.key), row)"
                    >
                      @switch (col.type) {
                        @case ('boolean') {
                          @if (col.editable) {
                            <sga-checkbox
                              [checked]="isRowPropertyTruthy(row, col.key)"
                              [label]="
                                col.booleanLabels?.[
                                  isRowPropertyTruthy(row, col.key) ? 'true' : 'false'
                                ] || ''
                              "
                              (changeOutput)="onBooleanToggle($event, col, row)"
                            />
                          } @else {
                            <span
                              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                              [class]="
                                isRowPropertyTruthy(row, col.key)
                                  ? 'bg-success-100 text-success-700'
                                  : 'bg-neutral-100 text-neutral-700'
                              "
                            >
                              <i
                                [class]="
                                  isRowPropertyTruthy(row, col.key)
                                    ? 'fas fa-check mr-1'
                                    : 'fas fa-times mr-1'
                                "
                              ></i>
                              {{ formatCell(row, col) }}
                            </span>
                          }
                        }

                        @case ('object') {
                          {{
                            col.objectKey
                              ? getNestedProperty(getRowProperty(row, col.key), col.objectKey)
                              : formatCell(row, col)
                          }}
                        }

                        @case ('array') {
                          @if (isArray(getRowProperty(row, col.key))) {
                            <span class="flex flex-wrap gap-1">
                              @for (
                                item of getVisibleItems(
                                  getRowPropertyAsArray(row, col.key),
                                  col.arrayMaxItems
                                );
                                track $index
                              ) {
                                <span
                                  class="inline-flex px-2 py-1 rounded-full text-xs font-medium bg-neutral-100 text-neutral-700"
                                  [class]="getValueColor(col, item)"
                                >
                                  {{ getArrayDisplay(item, col) }}
                                </span>
                              }
                              @if (
                                col.arrayMaxItems &&
                                getArrayLength(getRowProperty(row, col.key)) > col.arrayMaxItems
                              ) {
                                <span
                                  class="px-2 py-1 rounded-full text-xs bg-neutral-200 text-neutral-600"
                                >
                                  +{{
                                    getArrayLength(getRowProperty(row, col.key)) - col.arrayMaxItems
                                  }}
                                </span>
                              }
                            </span>
                          }
                        }

                        @default {
                          <span [class.truncate]="col.truncate">
                            {{ formatCell(row, col) }}
                          </span>
                        }
                      }
                    </td>
                  }
                }

                <!-- Actions -->
                @if (hasActions()) {
                  <td
                    class="px-4 py-3 sticky right-0 bg-base-100 dark:bg-base-200 border-l border-base-300 z-10"
                  >
                    <div class="relative flex items-center justify-center">
                      <button
                        type="button"
                        class="w-8 h-8 rounded-md text-neutral-600 hover:text-neutral-800 hover:bg-base-200 transition-colors"
                        (click)="toggleMenu(getRowId(row, i)); $event.stopPropagation()"
                        title="Acciones"
                      >
                        <i class="fas fa-ellipsis-v"></i>
                      </button>

                      @if (isMenuOpen(getRowId(row, i))) {
                        <div
                          class="absolute z-50 min-w-48 bg-base border border-base-300 rounded-lg shadow-xl right-0 bottom-full mb-2"
                        >
                          @for (action of filteredActions(); track action.key) {
                            @if (isVisible(action, row)) {
                              <button
                                type="button"
                                class="w-full px-4 py-2 text-sm text-left flex items-center gap-3 hover:bg-base-200 first:rounded-t-lg last:rounded-b-lg"
                                [class]="getActionClasses(action)"
                                [disabled]="isDisabled(action, row)"
                                (click)="executeAction(action, row); $event.stopPropagation()"
                              >
                                @if (action.icon) {
                                  <i [class]="action.icon + ' text-sm'"></i>
                                }
                                <span>{{ action.label }}</span>
                              </button>
                            }
                          }
                        </div>
                      }
                    </div>
                  </td>
                }
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
@if (config().pagination) {
  <div class="sticky bottom-0 left-0 w-full">
    <sga-pagination
      [total]="totalCount()"
      [size]="getSize()"
      [page]="getPage()"
      [useParams]="true"
      [sizeOptions]="[10, 20, 50, 100]"
    />
  </div>
}
